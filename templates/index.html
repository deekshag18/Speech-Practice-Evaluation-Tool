<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Speech Analyzer</title>
<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    
</head>
<body>

<h2>Speech Analyzer</h2>
<button onclick="startListening()">Start</button>
<button onclick="stopListening()">Stop</button>
<button onclick="generateReport()">Generate Report</button>

<h3>Live Transcript:</h3>
<div id="transcript"></div>

<h3>Analysis Report:</h3>
<div id="report"></div>

<script>
    let recognition;
    let transcriptText = '';
    let lastTimestamp = 0;

    function startListening() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert("Speech Recognition not supported in this browser.");
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        transcriptText = '';
        lastTimestamp = Date.now();

        recognition.onstart = () => console.log("Speech recognition started");

        recognition.onerror = (event) => {
            console.error("Recognition error:", event.error);
            alert("Speech Recognition Error: " + event.error);
        };

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                let result = event.results[i][0].transcript;
                const now = Date.now();
                if ((now - lastTimestamp) / 1000 > 8) {
                    result = '[pause_2s] ' + result;
                }
                lastTimestamp = now;

                if (event.results[i].isFinal) {
                    transcriptText += result + ' ';
                } else {
                    interimTranscript += result;
                }
            }
            document.getElementById('transcript').innerText = transcriptText + interimTranscript;
        };

        recognition.start();
    }

    function stopListening() {
        if (recognition) {
            recognition.stop();
            console.log("Speech recognition stopped");
        }
    }

    function generateReport() {
        if (!transcriptText.trim()) {
            alert("Please speak something first.");
            return;
        }

        fetch('/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ transcript: transcriptText.trim() })
        })
        .then(res => res.json())
        .then(data => {
            const report = `
                <b>Transcript:</b><br>${data.transcript}<br><br>
                <b>Filler Words:</b> ${data.filler_words_found.join(', ') || 'None'}<br>
                <b>Total Fillers:</b> ${data.total_fillers}<br>
                <b>Pauses :</b> ${data.pause_count}<br>
                <b>Fluency:</b> ${data.fluency}<br>
                <b>Structure:</b> ${data.structure_feedback}<br>
                <b>Confidence:</b> ${data.confidence}<br><br>
                <b>Grammar Issues:</b><ul>
                    ${data.grammar_issues.map(issue => `<li>${issue.message}<br><i>${issue.sentence}</i></li>`).join('')}
                </ul>
            `;
            document.getElementById('report').innerHTML = report;
        })
        .catch(err => {
            console.error("Error fetching report:", err);
            alert("Failed to analyze. See console.");
        });
    }
</script>

</body>
</html>
